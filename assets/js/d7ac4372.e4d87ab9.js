/*! For license information please see d7ac4372.e4d87ab9.js.LICENSE.txt */
(self.webpackChunk=self.webpackChunk||[]).push([[76474],{62525:e=>{"use strict";var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;function o(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(o){return!1}}()?Object.assign:function(e,i){for(var a,s,l=o(e),c=1;c<arguments.length;c++){for(var u in a=Object(arguments[c]))n.call(a,u)&&(l[u]=a[u]);if(t){s=t(a);for(var d=0;d<s.length;d++)r.call(a,s[d])&&(l[s[d]]=a[s[d]])}}return l}},41535:(e,t,n)=>{"use strict";var r=n(62525),o=60103,i=60106;var a=60109,s=60110,l=60112;var c=60115,u=60116;if("function"==typeof Symbol&&Symbol.for){var d=Symbol.for;o=d("react.element"),i=d("react.portal"),d("react.fragment"),d("react.strict_mode"),d("react.profiler"),a=d("react.provider"),s=d("react.context"),l=d("react.forward_ref"),d("react.suspense"),c=d("react.memo"),u=d("react.lazy")}var p="function"==typeof Symbol&&Symbol.iterator;var m={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},f={};function h(e,t,n){this.props=e,this.context=t,this.refs=f,this.updater=n||m}function y(){}function g(e,t,n){this.props=e,this.context=t,this.refs=f,this.updater=n||m}h.prototype.isReactComponent={},h.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},h.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},y.prototype=h.prototype;var b=g.prototype=new y;b.constructor=g,r(b,h.prototype),b.isPureReactComponent=!0;var v=Array.isArray,k=Object.prototype.hasOwnProperty,w={current:null},E={key:!0,ref:!0,__self:!0,__source:!0};function x(e,t,n){var r,i={},a=null,s=null;if(null!=t)for(r in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)k.call(t,r)&&!E.hasOwnProperty(r)&&(i[r]=t[r]);var l=arguments.length-2;if(1===l)i.children=n;else if(1<l){for(var c=Array(l),u=0;u<l;u++)c[u]=arguments[u+2];i.children=c}if(e&&e.defaultProps)for(r in l=e.defaultProps)void 0===i[r]&&(i[r]=l[r]);return{$$typeof:o,type:e,key:a,ref:s,props:i,_owner:w.current}}function C(e){return"object"==typeof e&&null!==e&&e.$$typeof===o}var O=/\/+/g;function S(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function T(e,t,n,r,a){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var l=!1;if(null===e)l=!0;else switch(s){case"string":case"number":l=!0;break;case"object":switch(e.$$typeof){case o:case i:l=!0}}if(l)return a=a(l=e),e=""===r?"."+S(l,0):r,v(a)?(n="",null!=e&&(n=e.replace(O,"$&/")+"/"),T(a,t,n,"",(function(e){return e}))):null!=a&&(C(a)&&(a=function(e,t){return{$$typeof:o,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(a,n+(!a.key||l&&l.key===a.key?"":(""+a.key).replace(O,"$&/")+"/")+e)),t.push(a)),1;if(l=0,r=""===r?".":r+":",v(e))for(var c=0;c<e.length;c++){var u=r+S(s=e[c],c);l+=T(s,t,n,u,a)}else if("function"==typeof(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e)))for(e=u.call(e),c=0;!(s=e.next()).done;)l+=T(s=s.value,t,n,u=r+S(s,c++),a);else if("object"===s)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return l}function N(e,t,n){if(null==e)return e;var r=[],o=0;return T(e,r,"","",(function(e){return t.call(n,e,o++)})),r}function A(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var j={current:null},P={transition:0}},27378:(e,t,n)=>{"use strict";n(41535)},3905:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>u,kt:()=>m});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=o,f=p["".concat(l,".").concat(m)]||p[m]||d[m]||i;return n?r.createElement(f,a(a({ref:t},u),{},{components:n})):r.createElement(f,a({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,a[1]=s;for(var c=2;c<i;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},80944:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});var r=n(67294),o=n(79443);const i=function(){const e=(0,r.useContext)(o.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e}},84195:(e,t,n)=>{"use strict";n.d(t,{Z:()=>r});const r=(0,n(67294).createContext)({selectedValue:"",setSelectedValue:e=>{throw new Error("No Tab provider")},values:[]})},70720:(e,t,n)=>{"use strict";n.d(t,{Z:()=>ye});var r=n(67294),o=n(24861),i=n(88300),a=n(71481),s=n(42910),l=n(99876),c=n(63312),u=n(33186),d=n(52803),p=n(44431),m=n.n(p),f=n(53775);class h extends f.Z{constructor(){super(...arguments),this.id=0}pk(){return`${this.id}`}static partialUpdate(){const e=super.partialUpdate();return e.extend({fetch:async(t,n)=>({...await e(t,n),id:t.id})})}static create(){const e=super.create();return e.extend({fetch:async(t,n)=>({...await e(t,n),id:n.id})})}}class y extends h{constructor(){super(...arguments),this.userId=0,this.title="",this.completed=!1}static partialUpdate(){return super.partialUpdate().extend({schema:this,optimisticUpdate:g})}static create(){const e=this.list().key({});return super.create().extend({schema:this,optimisticUpdate:b,update:t=>({[e]:function(e){return void 0===e&&(e=[]),[...e,t]}})})}static delete(){return super.delete().extend({optimisticUpdate:v})}}y.urlRoot="https://jsonplaceholder.typicode.com/todos";const g=(e,t)=>({id:e.id,...t}),b=(e,t)=>t,v=e=>e;var k=n(87462),w=n(50776),E=n(86010),x=n(95999),C=n(52263),O=n(72389),S=n(83229),T=n(55423),N=n(84195),A=n(58699),j=n(28808),P=n(96714),R=n(28224),_=n(80944),U=n(53810),I=n(91262);const Z="playgroundContainer_1vxj",D="row_3g4V",M="hidden_2rz-",F="playgroundHeader_2X75",$="playgroundEditor_1tQZ",H="playgroundPreview_3d_E",q="playgroundResult_5IAE",V="debugToggle_2KFu",B="tabControls_vH2K",L="tabs_1lMe",z="tab_3qyO",W="selected_3AAM";var X=n(60522),K=n(83552),G=n(85350);function Q(e){let{value:t}=e;const{isDarkTheme:n}=(0,G.Z)(),o=(0,r.useMemo)((()=>({String:"rgb(195, 232, 141)",Date:"rgb(247, 140, 108)",Number:"rgb(247, 140, 108)",Boolean:"rgb(247, 140, 108)",Null:"rgb(255, 88, 116)",Undefined:"rgb(255, 88, 116)",Function:"rgb(247, 140, 108)",Symbol:"rgb(247, 140, 108)"})),[]);return r.createElement(K.L,{shouldExpandNode:J,data:t,theme:{tree:{overflow:"auto",flex:"4 1 70%",margin:0,padding:"0 0.5rem","background-color":n?"var(--ifm-pre-background)":"rgb(41, 45, 62)",font:"var(--ifm-code-font-size) / var(--ifm-pre-line-height) var(--ifm-font-family-monospace) !important"},arrowContainer:(e,t)=>{let{style:n}=e;return{style:{...n,"font-family":"arial"}}},arrowSign:{color:"rgb(130, 170, 255)"},label:{color:"rgb(130, 170, 255)"},itemRange:{color:"rgb(105, 112, 152)"},valueText:(e,t)=>{let{style:n}=e;return{style:{...n,color:o[t]}}},base0B:"rgb(191, 199, 213)"}})}function J(e,t,n){return 0===n||(!(1!==n||!["entities","results"].includes(e[0]))||(2===n&&"entities"===e[1]||(2===n&&"results"===e[1]||(3===n&&"entities"===e[2]||3===n&&"results"===e[2]))))}function Y(e){let{toggle:t,selectedValue:n}=e;return r.createElement(r.Fragment,null,r.createElement("div",{className:V,onClick:t},"Store"),"y"===n?r.createElement(ne,null):null)}const ee=(0,r.memo)(Y);function te(){const e=(0,r.useContext)(X.sA),t=(0,r.useMemo)((()=>{const t={...e};return delete t.optimistic,delete t.lastReset,t}),[e]);return r.createElement(Q,{value:t})}const ne=(0,r.memo)(te);function re(e){let{groupId:t,defaultOpen:n,row:o}=e;const{tabGroupChoices:i,setTabGroupChoices:a}=(0,_.Z)(),[s,l]=(0,r.useState)(n),{blockElementScrollPositionUntilNextRender:c}=(0,U.o5)();if(null!=t){const e=i[t];null!=e&&e!==s&&l(e)}const u=(0,r.useCallback)((e=>{c(e.currentTarget),l((e=>"y"===e?"n":"y")),a(t,"y"===s?"n":"y")}),[c,t,s,a]),d=(0,r.useMemo)((()=>[new R.Z,new A.Z(j.Z)]),[]),p=!("n"===s||!o);return r.createElement(P.nq,{managers:d},r.createElement("div",{className:(0,E.Z)(H,{[M]:p})},r.createElement(I.Z,{fallback:r.createElement(ie,null)},(()=>r.createElement(r.Suspense,{fallback:r.createElement(ie,null)},r.createElement(w.i5,null),r.createElement(w.IF,null))))),r.createElement(ee,{selectedValue:s,toggle:u}))}const oe=(0,r.memo)(re);function ie(){return r.createElement("div",null,"Loading...")}function ae(e){let{children:t,className:n}=e;return r.createElement("div",{className:(0,E.Z)(F,n)},t)}function se(e){let{groupId:t,defaultOpen:n,row:o}=e;return r.createElement("div",null,r.createElement(ae,null,r.createElement(x.Z,{id:"theme.Playground.result",description:"The result label of the live codeblocks"},"Result")),r.createElement("div",{className:q},r.createElement(oe,{groupId:t,defaultOpen:n,row:o})))}function le(){const{selectedValue:e,setSelectedValue:t,values:n}=(0,r.useContext)(N.Z);return r.createElement("div",{className:L,role:"tablist","aria-orientation":"horizontal"},n.map((n=>{let{value:o,label:i}=n;return r.createElement("div",{role:"tab",tabIndex:e===o?0:-1,"aria-selected":e===o,key:o,className:(0,E.Z)(z,{[W]:e===o}),onFocus:t,onClick:t,value:o},i)})))}function ce(e){let{children:t}=e;return r.createElement(ae,{className:B},r.createElement("div",null,t),r.createElement(le,null))}function ue(e){let{title:t}=e;const{values:n}=(0,r.useContext)(N.Z),o=n.length>0,i=(0,O.Z)();return r.createElement("div",null,o?r.createElement(ce,null,t):r.createElement(ae,null,t),r.createElement(w.uz,{key:i,className:$}))}function de(e){let{children:t,transformCode:n,groupId:o,defaultOpen:i,row:a,hidden:s=!1,...l}=e;const{siteConfig:{themeConfig:{liveCodeBlock:{playgroundPosition:c}}}}=(0,C.Z)(),u=(0,S.Z)();l.scope;return r.createElement("div",{className:(0,E.Z)(Z,{[D]:a,[M]:s})},r.createElement(w.nu,(0,k.Z)({code:t.replace(/\n$/,""),transformCode:n||(e=>(e=>T.transpileModule(e,{compilerOptions:{module:T.ModuleKind.ESNext,target:T.ScriptTarget.ES5,jsx:"react"}}).outputText)(`${e};`)),transpileOptions:{target:{chrome:71},transforms:{classes:!1,letConst:!1,getterSetter:!1,generator:!1,asyncAwait:!1,moduleImport:!1,moduleExport:!1}},theme:u},l),"top"===c?r.createElement(r.Fragment,null,r.createElement(se,{groupId:o,defaultOpen:i,row:a}),r.createElement(ue,null)):r.createElement(r.Fragment,null,r.createElement(ue,null),r.createElement(se,{groupId:o,defaultOpen:i,row:a}))))}ue.defaultProps={title:r.createElement(x.Z,{id:"theme.Playground.liveEditor",description:"The live editor label of the live codeblocks"},"Live Editor")},de.defaultProps={row:!1};class pe extends c.Z{constructor(){super(...arguments),this.id=""}pk(){return this.id}}pe.schema={updatedAt:Date};const me=new i.Z((e=>{let{id:t}=e;return fetch(`/api/currentTime/${t}`).then((e=>e.json()))}),{schema:pe});const fe={...o,...l,...d,...u,mockFetch:function(e,t,n){void 0===n&&(n=150);const r=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return new Promise((t=>setTimeout((()=>t(e(...r))),n)))};return t&&Object.defineProperty(r,"name",{value:t,writable:!1}),r},BigNumber:m(),lastUpdated:me,TimedEntity:pe,CurrentTime:function(){const[e,t]=(0,r.useState)((()=>new Date));return(0,r.useEffect)((()=>{const e=setInterval((()=>t(new Date)));return()=>clearInterval(e)}),[]),r.createElement("time",null,Intl.DateTimeFormat("en-US",{timeStyle:"long"}).format(e))},ResetableErrorBoundary:function(e){let{children:t}=e;const[n,o]=r.useState(0),{resetEntireStore:i}=a.Z();return r.createElement(s.Z,{key:n,fallbackComponent:e=>{let{error:t}=e;return r.createElement(r.Fragment,null,r.createElement("div",null,t.message," ",r.createElement("i",null,t.status)),r.createElement("button",{onClick:()=>{i(),o((e=>e+1))}},"Clear Error"))}},t)},TodoResource:class extends y{static list(){const e=super.list();return e.extend({async fetch(){return(await e(...arguments)).slice(0,5)}})}}},he=e=>{let{children:t,groupId:n,hidden:o=!1,defaultOpen:i="n",row:a=!1}=e;return r.createElement(de,{scope:fe,noInline:!0,groupId:n,defaultOpen:i,row:a,hidden:o},"string"==typeof t?t:t.props.children.props.children)},ye=(0,r.memo)(he)},316:(e,t,n)=>{"use strict";n.r(t),n.d(t,{frontMatter:()=>a,contentTitle:()=>s,metadata:()=>l,toc:()=>c,default:()=>d});var r=n(87462),o=(n(27378),n(3905)),i=n(70720);const a={title:"Optimistic Updates"},s=void 0,l={unversionedId:"guides/optimistic-updates",id:"guides/optimistic-updates",title:"Optimistic Updates",description:"Optimistic updates enable highly responsive and fast interfaces by avoiding network wait times.",source:"@site/../docs/guides/optimistic-updates.md",sourceDirName:"guides",slug:"/guides/optimistic-updates",permalink:"/docs/next/guides/optimistic-updates",editUrl:"https://github.com/coinbase/rest-hooks/edit/master/docs/guides/optimistic-updates.md",tags:[],version:"current",lastUpdatedBy:"Nathaniel Tucker",lastUpdatedAt:1642979014,formattedLastUpdatedAt:"1/23/2022",frontMatter:{title:"Optimistic Updates"},sidebar:"docs",previous:{title:"Immediate Mutation Updates",permalink:"/docs/next/guides/immediate-updates"},next:{title:"Aborting Fetch",permalink:"/docs/next/guides/abort"}},c=[{value:"Partial updates",id:"partial-updates",children:[{value:"ArticleResource.ts",id:"articleresourcets",children:[],level:3},{value:"PublishButton.tsx",id:"publishbuttontsx",children:[],level:3}],level:2},{value:"Optimistic create with instant updates",id:"optimistic-create-with-instant-updates",children:[{value:"ArticleResource.ts",id:"articleresourcets-1",children:[],level:3},{value:"CreateArticle.tsx",id:"createarticletsx",children:[],level:3}],level:2},{value:"Optimistic Deletes",id:"optimistic-deletes",children:[],level:2},{value:"Optimistic Transforms",id:"optimistic-transforms",children:[{value:"Vector Clocks",id:"vector-clocks",children:[],level:3}],level:2}],u={toc:c};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Optimistic updates enable highly responsive and fast interfaces by avoiding network wait times.\nAn update is optimistic by assuming the network is successful. In the case of any errors, Rest\nHooks will then roll back any changes in a way that deals with all possible race conditions."),(0,o.kt)("h2",{id:"partial-updates"},"Partial updates"),(0,o.kt)("p",null,"One common use case is for quick toggles. Here we demonstrate a publish button for an\narticle. Note that we need to include the primary key (",(0,o.kt)("inlineCode",{parentName:"p"},"id")," in this case) in the response\nbody to ensure the normalized cache gets updated correctly."),(0,o.kt)("h3",{id:"articleresourcets"},"ArticleResource.ts"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { MutateEndpoint, SchemaDetail, AbstractInstanceType } from 'rest-hooks';\nimport { Resource } from '@rest-hooks/rest';\n\nexport default class ArticleResource extends Resource {\n  readonly id: string | undefined = undefined;\n  readonly title: string = '';\n  readonly content: string = '';\n  readonly published: boolean = false;\n\n  pk() {\n    return this.id;\n  }\n\n  static partialUpdate<T extends typeof Resource>(\n    this: T,\n  ): MutateEndpoint<\n    (p: Readonly<object>, b: Partial<AbstractInstanceType<T>>) => Promise<any>,\n    SchemaDetail<Readonly<AbstractInstanceType<T>>>\n  > {\n    return super.partialUpdate().extend({\n      optimisticUpdater: (snap, params, body) => ({\n        // we absolutely need the primary key here,\n        // but won't be sent in a partial update\n        id: params.id,\n        ...body,\n      }),\n    });\n  }\n}\n")),(0,o.kt)("h3",{id:"publishbuttontsx"},"PublishButton.tsx"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { useController } from 'rest-hooks';\nimport ArticleResource from 'ArticleResource';\n\nexport default function PublishButton({ id }: { id: string }) {\n  const { fetch } = useController();\n\n  return (\n    <button\n      onClick={() =>\n        fetch(ArticleResource.partialUpdate(), { id }, { published: true })\n      }\n    >\n      Publish\n    </button>\n  );\n}\n")),(0,o.kt)("h2",{id:"optimistic-create-with-instant-updates"},"Optimistic create with instant updates"),(0,o.kt)("p",null,"Optimistic updates can also be combined with ",(0,o.kt)("a",{parentName:"p",href:"./immediate-updates"},"immediate updates"),", enabling updates to\nother endpoints instantly. This is most commonly seen when creating new items\nwhile viewing a list of them."),(0,o.kt)("p",null,"Here we demonstrate what could be used in a list of articles with a modal\nto create a new article. On submission of the form it would instantly\nadd to the list of articles the newly created article - without waiting on a network response."),(0,o.kt)("h3",{id:"articleresourcets-1"},"ArticleResource.ts"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { MutateEndpoint, AbstractInstanceType } from 'rest-hooks';\nimport { SchemaDetail, Resource } from '@rest-hooks/rest';\n\nexport default class ArticleResource extends Resource {\n  readonly id: string | undefined = undefined;\n  readonly title: string = '';\n  readonly content: string = '';\n  readonly published: boolean = false;\n\n  pk() {\n    return this.id;\n  }\n\n  static create<T extends typeof Resource>(\n    this: T,\n  ): MutateEndpoint<\n    (p: Readonly<object>, b: Partial<AbstractInstanceType<T>>) => Promise<any>,\n    SchemaDetail<Readonly<AbstractInstanceType<T>>>\n  > {\n    return super.create().extend({\n      optimisticUpdater: (snap, params, body) => body,\n    });\n  }\n}\n\nexport const appendUpdater = (\n  newArticleID: string,\n  articleIDs: string[] | undefined,\n) => [...(articleIDs || []), newArticleID];\n")),(0,o.kt)("h3",{id:"createarticletsx"},"CreateArticle.tsx"),(0,o.kt)("p",null,"Since the actual ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," of the article is created on the server, we will need to fill\nin a temporary fake ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," here, so the ",(0,o.kt)("inlineCode",{parentName:"p"},"primary key")," can be generated. This is needed\nto properly normalize the article to be looked up in the cache."),(0,o.kt)("p",null,"Once the network responds, it will have a different ",(0,o.kt)("inlineCode",{parentName:"p"},"id"),", which will replace the existing\ndata. This is often seamless, but care should be taken if the fake ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," is used in any\nrenders - like to issue subsequent requests. We recommend disabling ",(0,o.kt)("inlineCode",{parentName:"p"},"edit")," type features\nthat rely on the ",(0,o.kt)("inlineCode",{parentName:"p"},"primary key")," until the network fetch completes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { useController } from 'rest-hooks';\nimport uuid from 'uuid/v4';\nimport ArticleResource from 'ArticleResource';\n\nexport default function CreateArticle() {\n  const { fetch } = useController();\n  const submitHandler = useCallback(\n    data =>\n      // note the fake id we create.\n      fetch(ArticleResource.create(), {}, { id: uuid(), ...data }, [\n        [ArticleResource.list(), {}, appendUpdater],\n      ]),\n    [create],\n  );\n\n  return <Form onSubmit={submitHandler}>{/* rest of form */}</Form>;\n}\n")),(0,o.kt)("h2",{id:"optimistic-deletes"},"Optimistic Deletes"),(0,o.kt)("p",null,"Since deletes ",(0,o.kt)("a",{parentName:"p",href:"./immediate-updates#delete"},"automatically update the cache correctly")," upon fetch success,\nmaking your delete endpoint do this optimistically is as easy as adding the ",(0,o.kt)("a",{parentName:"p",href:"../api/Endpoint#optimisticupdater"},"optimisticUpdater"),"\nfunction to your options."),(0,o.kt)("p",null,"We return an empty string because that's the response we expect from the server. Although by\ndefault, the server response is ignored."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { Resource, SimpleResource } from '@rest-hooks/rest';\nimport { MutateEndpoint } from 'rest-hooks';\n\nexport default class ArticleResource extends Resource {\n  readonly id: string | undefined = undefined;\n  readonly title: string = '';\n  readonly content: string = '';\n  readonly published: boolean = false;\n\n  pk() {\n    return this.id;\n  }\n\n  static delete<T extends typeof Resource>(\n    this: T,\n  ): MutateEndpoint<(p: Readonly<object>) => Promise<any>, schemas.Delete<T>> {\n    return super.delete().extend({\n      optimisticUpdater: (snap, params, body) => params,\n    });\n  }\n}\n")),(0,o.kt)("h2",{id:"optimistic-transforms"},"Optimistic Transforms"),(0,o.kt)("p",null,"Sometimes user actions should result in data transformations that are dependent on the previous state of data.\nThe simplest examples of this are toggling a boolean, or incrementing a counter; but the same principal applies to\nmore complicated transforms. To make it more obvious we're using a simple counter here."),(0,o.kt)(i.Z,{mdxType:"HooksPlayground"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"class CountEntity extends Entity {\n  readonly id = 0;\n  readonly count = 0;\n\n  pk() {\n    return `${this.id}`;\n  }\n}\nconst simulatedServerStateCount = 0;\nconst getCount = new Endpoint(\n  (id: number) => Promise.resolve({ id, count: simulatedServerStateCount }),\n  {\n    name: 'get',\n    schema: CountEntity,\n  },\n);\nconst increment = new Endpoint(\n  (id: number) =>\n    new Promise(resolve => {\n      const serverState = { id, count: ++simulatedServerStateCount };\n      // resolve from 500ms -> 5 seconds. Represents network variance.\n      // making state computed before hand allows demonstrating out of order race conditions\n      setTimeout(() => resolve(serverState), 500 + Math.random() * 4500);\n    }),\n  {\n    name: 'increment',\n    schema: CountEntity,\n    sideEffect: true,\n    optimisticUpdater(snap, id) {\n      const { data } = snap.getResponse(increment, id);\n      if (!data) throw new AbortOptimistic();\n      return {\n        id,\n        count: data.count + 1,\n      };\n    },\n  },\n);\n\nfunction CounterPage() {\n  const { fetch } = useController();\n  const { count } = useSuspense(getCount, 1);\n  const [clickHandler, loading, error] = useLoading(() => fetch(increment, 1));\n  return (\n    <div>\n      <p>\n        Click the button multiple times quickly to trigger the race condition\n      </p>\n      <div>\n        {count} <button onClick={clickHandler}>+</button>\n        {loading ? ' ...loading' : ''}\n      </div>\n    </div>\n  );\n}\nrender(<CounterPage />);\n"))),(0,o.kt)("p",null,"Try removing ",(0,o.kt)("inlineCode",{parentName:"p"},"optimisticUpdater")," from the increment ",(0,o.kt)("a",{parentName:"p",href:"/docs/next/api/Endpoint"},"Endpoint"),". Even without optimistic updates, this race condition can be a real problem. While it is less likely with fast endpoints;\nslower or less reliable internet connections means a slow response time no matter how fast the server is."),(0,o.kt)("p",null,"The problem is that the responses come back in a different order than they are computed. If we can determine the\ncorrect 'total order', we would be able to solve this problem."),(0,o.kt)("p",null,"Without optimistic updates, this can be achieved simply by having the server return a timestamp of when it was last updated.\nThe client can then choose to ignore responses that are out of date by their time of resolution."),(0,o.kt)("h3",{id:"vector-clocks"},"Vector Clocks"),(0,o.kt)("p",null,"However, when doing an optimistic update, we now have two distinct nodes computed derived data. Optimistic updates\nrepresent the client's computation and the server also computes derivations. Much like the ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Theory_of_relativity"},"real world"),"\nagreeing on a total order of events is no longer possible. However, using ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Vector_clock"},"vector clocks"),"\nallows us to maintain agreement on a ",(0,o.kt)("em",{parentName:"p"},"casual")," order."),(0,o.kt)("p",null,"The key things to observe in the code example is the added field ",(0,o.kt)("inlineCode",{parentName:"p"},"updatedAt"),", which is our vector clock, as well\nas how it is used in our new ",(0,o.kt)("a",{parentName:"p",href:"../api/Entity#merge"},"static merge()")," as well as updates to ",(0,o.kt)("a",{parentName:"p",href:"/docs/next/api/Endpoint#optimisticupdater"},"optimisticUpdater"),"."),(0,o.kt)(i.Z,{mdxType:"HooksPlayground"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"class CountEntity extends Entity {\n  readonly id = 0;\n  readonly count = 0;\n  readonly updatedAt = { client: 0, server: 0 };\n\n  pk() {\n    return `${this.id}`;\n  }\n\n  static merge(existing, incoming) {\n    if (\n      existing.updatedAt.client < incoming.updatedAt.client ||\n      existing.updatedAt.server < incoming.updatedAt.server\n    ) {\n      return {\n        ...existing,\n        ...incoming,\n        updatedAt: {\n          client: Math.max(\n            existing.updatedAt.client,\n            incoming.updatedAt.client,\n          ),\n          server: Math.max(\n            existing.updatedAt.server,\n            incoming.updatedAt.server,\n          ),\n        },\n      };\n    }\n    return existing;\n  }\n}\nconst simulatedServerStateCount = 0;\nconst getCount = new Endpoint(\n  (id: number) =>\n    Promise.resolve({\n      id,\n      count: simulatedServerStateCount,\n      updatedAt: { client: 0, server: Date.now() },\n    }),\n  {\n    name: 'get',\n    schema: CountEntity,\n  },\n);\nconst increment = new Endpoint(\n  (id: number) =>\n    new Promise(resolve => {\n      const serverState = {\n        id,\n        count: ++simulatedServerStateCount,\n        updatedAt: { client: Date.now(), server: Date.now() + 200 },\n      };\n      // resolve from 500ms -> 5 seconds. Represents network variance.\n      // making state computed before hand allows demonstrating out of order race conditions\n      setTimeout(() => resolve(serverState), 500 + Math.random() * 4500);\n    }),\n  {\n    name: 'increment',\n    schema: CountEntity,\n    sideEffect: true,\n    optimisticUpdater(snap, id) {\n      const { data } = snap.getResponse(increment, id);\n      // server already has this optimistic computation then do nothing\n      if (!data || snap.date <= data.updatedAt.client) throw new AbortOptimistic();\n      return {\n        id,\n        count: data.count + 1,\n        updatedAt: {\n          client: snap.date,\n          server: data.updatedAt.server,\n        },\n      };\n    },\n  },\n);\n\nfunction CounterPage() {\n  const { fetch } = useController();\n  const { count } = useSuspense(getCount, 1);\n  const [clickHandler, loading, error] = useLoading(() => fetch(increment, 1));\n  return (\n    <div>\n      <p>\n        Click the button multiple times quickly to trigger the potential race condition.\n        This time our vector clock protects us.\n      </p>\n      <div>\n        {count} <button onClick={clickHandler}>+</button>\n        {loading ? ' ...loading' : ''}\n      </div>\n    </div>\n  );\n}\nrender(<CounterPage />);\n"))))}d.isMDXComponent=!0},13411:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=13411,e.exports=t},62715:()=>{},13611:()=>{},43454:()=>{}}]);